<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ® ã‚²ãƒ¼ãƒ æ©Ÿ è²·å–ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f5f7;
  --card: #ffffff;
  --header-bg: #1a1a2e;
  --header-text: #ffffff;
  --primary: #4361ee;
  --primary-light: #eef0ff;
  --success: #10b981;
  --success-light: #ecfdf5;
  --warning: #f59e0b;
  --warning-light: #fffbeb;
  --danger: #ef4444;
  --text: #1a1a2e;
  --text-secondary: #6b7280;
  --border: #e5e7eb;
  --radius: 12px;
  --font-ja: 'Zen Kaku Gothic New', sans-serif;
  --font-en: 'DM Sans', sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-ja); background: var(--bg); color: var(--text); min-height: 100vh; }

/* Header */
.header { background: var(--header-bg); color: var(--header-text); padding: 24px 20px; }
.header h1 { font-size: 1.5rem; font-weight: 900; margin-bottom: 4px; }
.header .meta { font-size: 0.8rem; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 8px; }
.header .meta .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; }

/* Tabs */
.tabs { display: flex; background: var(--card); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; }
.tab { flex: 1; padding: 14px; text-align: center; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; }
.tab:hover { color: var(--text); background: #f9f9fb; }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }

/* Container */
.container { max-width: 900px; margin: 0 auto; padding: 16px; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Cards */
.card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.card h2 { font-size: 1.1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* Simulator */
.input-group { margin-bottom: 16px; }
.input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; }
.input-group .hint { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }
.input-row { display: flex; gap: 12px; align-items: flex-end; }
.input-row .input-group { flex: 1; }
input[type="number"], select {
  width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px;
  font-size: 1rem; font-family: var(--font-en); transition: border-color 0.2s;
}
input:focus, select:focus { outline: none; border-color: var(--primary); }
.btn-primary {
  width: 100%; padding: 14px; background: var(--primary); color: white; border: none;
  border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s;
}
.btn-primary:hover { opacity: 0.9; }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

/* Filters */
.filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.filter-btn {
  padding: 6px 16px; border: 2px solid var(--border); border-radius: 20px;
  background: white; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;
}
.filter-btn:hover { border-color: var(--primary); color: var(--primary); }
.filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Product list */
.product-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; border-bottom: 1px solid var(--border); transition: background 0.15s;
}
.product-item:last-child { border-bottom: none; }
.product-item:hover { background: #f9f9fb; }
.product-info { flex: 1; min-width: 0; }
.product-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.product-prices { display: flex; gap: 8px; align-items: center; font-size: 0.8rem; color: var(--text-secondary); }
.product-prices .arrow { color: #ccc; }
.product-prices .buyback { color: var(--success); font-weight: 700; font-family: var(--font-en); }
.product-rate {
  font-family: var(--font-en); font-weight: 700; font-size: 0.95rem;
  min-width: 70px; text-align: right;
}
.rate-high { color: var(--success); }
.rate-mid { color: var(--warning); }
.rate-low { color: var(--danger); }

/* Result card */
.result-card {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border: 2px solid #f59e0b; border-radius: var(--radius); padding: 20px; margin-top: 16px;
}
.result-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.result-badge { background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; }
.result-stats {
  display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 16px;
  font-family: var(--font-en); text-align: center;
}
.result-stat { flex: 1; min-width: 80px; }
.result-stat .value { font-size: 1.3rem; font-weight: 700; }
.result-stat .value.profit { color: var(--success); }
.result-stat .label { font-size: 0.7rem; color: var(--text-secondary); font-family: var(--font-ja); }
.result-item {
  background: white; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px;
  display: flex; align-items: center; justify-content: space-between;
}
.result-item .qty-controls { display: flex; align-items: center; gap: 8px; }
.result-item .qty-btn {
  width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
  background: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center;
}
.result-item .qty-btn:hover { border-color: var(--primary); color: var(--primary); }
.result-item-highlight { background: #fffde7; }
.result-remaining { text-align: center; color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px; }

/* Custom tab */
.custom-summary {
  background: var(--primary-light); border-radius: 8px; padding: 16px; margin-bottom: 16px;
  display: flex; flex-wrap: wrap; gap: 16px; font-family: var(--font-en); text-align: center;
}
.custom-stat { flex: 1; min-width: 80px; }
.custom-stat .value { font-size: 1.2rem; font-weight: 700; }
.custom-stat .label { font-size: 0.7rem; color: var(--text-secondary); font-family: var(--font-ja); }
.custom-product {
  display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);
}
.custom-product:last-child { border-bottom: none; }
.custom-product input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); }

/* Footer */
.footer { text-align: center; padding: 24px; color: var(--text-secondary); font-size: 0.75rem; }
.footer a { color: var(--primary); }

/* Loading */
.loading { text-align: center; padding: 40px; color: var(--text-secondary); }

/* Responsive */
@media (max-width: 600px) {
  .input-row { flex-direction: column; }
  .result-stats { gap: 8px; }
  .result-stat .value { font-size: 1.1rem; }
  .product-item { flex-direction: column; align-items: flex-start; gap: 6px; }
  .product-rate { text-align: left; }
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ® ã‚²ãƒ¼ãƒ æ©Ÿ è²·å–ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
  <div class="meta">
    <span class="dot"></span>
    <span id="lastUpdate">èª­ã¿è¾¼ã¿ä¸­...</span>
    <span>ãƒ‡ãƒ¼ã‚¿å…ƒ: ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="simulator">ğŸ” ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
  <div class="tab" data-tab="custom">ğŸ›  æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</div>
  <div class="tab" data-tab="products">ğŸ“¦ å…¨å•†å“ä¸€è¦§</div>
</div>

<div class="container">

  <!-- Tab 1: Simulator -->
  <div id="tab-simulator" class="tab-content active">
    <div class="card">
      <h2>ğŸ¯ ãƒã‚¤ãƒ³ãƒˆæ¶ˆåŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
      <div class="input-row">
        <div class="input-group">
          <label>æŒã£ã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆï¼ˆå††ç›¸å½“ï¼‰</label>
          <input type="number" id="pointsInput" value="145000" min="1000" step="1000">
          <div class="hint">ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©ãƒ»ãƒ¤ãƒãƒ€é›»æ©Ÿç­‰ã®ãƒã‚¤ãƒ³ãƒˆ</div>
        </div>
        <div class="input-group">
          <label>å€‹æ•°ä¸Šé™</label>
          <select id="maxItemsSelect">
            <option value="5">5å€‹</option>
            <option value="8" selected>8å€‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰</option>
            <option value="12">12å€‹</option>
            <option value="20">20å€‹</option>
            <option value="999">åˆ¶é™ãªã—</option>
          </select>
        </div>
      </div>
      <div class="input-group" style="margin-top:8px">
        <label>ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <div class="filters" id="simFilters"></div>
      </div>
      <button class="btn-primary" id="searchBtn" onclick="executeSearch()">ğŸ” æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’æ¤œç´¢</button>
    </div>
    <div id="searchResult"></div>
  </div>

  <!-- Tab 2: Custom -->
  <div id="tab-custom" class="tab-content">
    <div class="card">
      <h2>ğŸ›  æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h2>
      <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:16px;">å•†å“ã‚’è‡ªåˆ†ã§é¸ã‚“ã§çµ„ã¿åˆã‚ã›ã‚’ç¢ºèªã§ãã¾ã™</p>
      <div class="custom-summary" id="customSummary">
        <div class="custom-stat"><div class="value" id="customTotal">Â¥0</div><div class="label">åˆè¨ˆå®šä¾¡</div></div>
        <div class="custom-stat"><div class="value" id="customBuyback">Â¥0</div><div class="label">åˆè¨ˆè²·å–</div></div>
        <div class="custom-stat"><div class="value" id="customProfit">Â¥0</div><div class="label">åˆ©ç›Š</div></div>
        <div class="custom-stat"><div class="value" id="customRate">0%</div><div class="label">å¹³å‡è²·å–ç‡</div></div>
      </div>
      <div id="customList"></div>
    </div>
  </div>

  <!-- Tab 3: All Products -->
  <div id="tab-products" class="tab-content">
    <div class="card">
      <h2>ğŸ“Š å…¨å•†å“ä¸€è¦§</h2>
      <div class="filters" id="productFilters"></div>
      <div id="productList"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    </div>
  </div>

</div>

<div class="footer">
  ãƒ‡ãƒ¼ã‚¿å…ƒ: <a href="https://www.mobile-ichiban.com/Prod/2/01" target="_blank">ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª</a> | 3æ™‚é–“ã”ã¨è‡ªå‹•æ›´æ–°<br>
  Â© 2026 C-Creation
</div>

<script>
// =============================================================================
// EMBEDDED_DATA - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼v6ãŒè‡ªå‹•æ›´æ–°ï¼ˆè²·å–0å††ã®å ´åˆã¯ã“ã“ã®å€¤ã‚’ä½¿ç”¨ï¼‰
// =============================================================================
const EMBEDDED_DATA = [
  {"name":"Nintendo Switch (æœ‰æ©ŸELãƒ¢ãƒ‡ãƒ«) ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼ãƒ»ãƒã‚ªãƒ³ãƒ¬ãƒƒãƒ‰","jan":"4902370548501","buyback":40700,"retail":37980,"rate":107.16,"category":"Switch"},
  {"name":"Nintendo Switch (æœ‰æ©ŸELãƒ¢ãƒ‡ãƒ«) ãƒ›ãƒ¯ã‚¤ãƒˆ","jan":"4902370548495","buyback":40700,"retail":37980,"rate":107.16,"category":"Switch"},
  {"name":"PlayStation 5 Pro CFI-7000B01 2TB","jan":"4948872416320","buyback":107300,"retail":119980,"rate":89.43,"category":"PS5"},
  {"name":"PlayStation 5 slim CFI-2000A01","jan":"4948872415934","buyback":74700,"retail":79980,"rate":93.4,"category":"PS5"},
  {"name":"Meta Quest 3S 128GB","jan":"0815820025238","buyback":38600,"retail":48400,"rate":79.75,"category":"Meta Quest"},
  {"name":"Steam Deck OLED 1TB","jan":"0814585022308","buyback":103800,"retail":99800,"rate":104.01,"category":"Steam Deck"},
  {"name":"ROG Xbox Ally X 1TB","jan":"0199291152984","buyback":133200,"retail":139800,"rate":95.28,"category":"ãã®ä»–"},
  {"name":"Nintendo Switch 2 Pokemon LEGENDS Z-A ã‚»ãƒƒãƒˆ å›½å†…ç‰ˆ","jan":"4902370553505","buyback":51000,"retail":49980,"rate":102.04,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 å¤šè¨€èªå¯¾å¿œç‰ˆ","jan":"4902370552683","buyback":85000,"retail":69980,"rate":121.46,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 å›½å†…ç‰ˆ","jan":"4902370553024","buyback":46300,"retail":49980,"rate":92.64,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆ ãƒ¯ãƒ¼ãƒ«ãƒ‰ ã‚»ãƒƒãƒˆ å›½å†…ç‰ˆ","jan":"4902370553031","buyback":51500,"retail":55980,"rate":92.0,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 Proã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼","jan":"4902370552843","buyback":8300,"retail":9878,"rate":84.03,"category":"Switch 2"},
  {"name":"Joy-Con 2 (L)/(R) ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼/ãƒ©ã‚¤ãƒˆãƒ¬ãƒƒãƒ‰","jan":"4902370552744","buyback":8600,"retail":9878,"rate":87.06,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con 2 (L) ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼","jan":"4902370552706","buyback":3500,"retail":5478,"rate":63.89,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con 2 (R) ãƒ©ã‚¤ãƒˆãƒ¬ãƒƒãƒ‰","jan":"4902370552720","buyback":3500,"retail":5478,"rate":63.89,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 ãƒ‰ãƒƒã‚¯ã‚»ãƒƒãƒˆ","jan":"4902370552911","buyback":11200,"retail":12980,"rate":86.29,"category":"Switch 2"},
  {"name":"SanDisk microSD Express Card 256GB for Nintendo Switch 2","jan":"4523052030185","buyback":5800,"retail":6578,"rate":88.17,"category":"Switch 2"},
  {"name":"Samsung microSD Express Card 256GB for Nintendo Switch 2","jan":"8806095700670","buyback":5800,"retail":6578,"rate":88.17,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con(L) ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼/(R) ãƒã‚ªãƒ³ãƒ¬ãƒƒãƒ‰ æ–°å‹","jan":"4902370550733","buyback":32500,"retail":32978,"rate":98.55,"category":"Switch"},
  {"name":"instax mini Evo Cinema","jan":"4547410562293","buyback":49000,"retail":47300,"rate":103.59,"category":"ãã®ä»–"},
  {"name":"instax WIDE 400 ãƒã‚§ã‚­","jan":"4547410529975","buyback":21500,"retail":26730,"rate":80.43,"category":"ãã®ä»–"},
  {"name":"instax mini 99 ãƒ–ãƒ©ãƒƒã‚¯","jan":"4547410529845","buyback":24700,"retail":30580,"rate":80.77,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ç”¨ãƒ•ã‚£ãƒ«ãƒ  20æšå…¥ INSTAX MINI JP 2","jan":"4547410377231","buyback":2680,"retail":2100,"rate":127.62,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ç”¨ãƒ•ã‚£ãƒ«ãƒ  10æšå…¥ INSTAX MINI JP 1","jan":"4547410377224","buyback":1300,"retail":1100,"rate":118.18,"category":"ãã®ä»–"},
  {"name":"FUJIFILM å†™ãƒ«ãƒ³ã§ã™ ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ¼ã‚¹ 27æšæ’®ã‚Š","jan":"4547410369137","buyback":2600,"retail":2178,"rate":119.38,"category":"ãã®ä»–"},
  {"name":"FUJIFILM å†™ãƒ«ãƒ³ã§ã™ ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ¼ã‚¹ 27æšæ’®ã‚Š 2025ç‰ˆ","jan":"4547410550955","buyback":2500,"retail":2178,"rate":114.78,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ã‚¹ã‚¯ã‚¨ã‚¢ç”¨ ãƒ•ã‚£ãƒ«ãƒ  20æš WW2","jan":"4547410370003","buyback":2400,"retail":2100,"rate":114.29,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ã‚¹ã‚¯ã‚¨ã‚¢ç”¨ ãƒ•ã‚£ãƒ«ãƒ  10æš WW1","jan":"4547410348613","buyback":1200,"retail":1100,"rate":109.09,"category":"ãã®ä»–"},
  {"name":"instax mini 90 ãƒã‚§ã‚­ ãƒã‚ªã‚¯ãƒ©ã‚·ãƒƒã‚¯ ãƒ–ãƒ©ãƒƒã‚¯","jan":"4547410260649","buyback":43500,"retail":28600,"rate":152.1,"category":"ãã®ä»–"},
  {"name":"instax mini 90 ãƒã‚§ã‚­ ãƒã‚ªã‚¯ãƒ©ã‚·ãƒƒã‚¯ ãƒ–ãƒ©ã‚¦ãƒ³","jan":"4547410269307","buyback":43500,"retail":28600,"rate":152.1,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ã‚¯ãƒ¬ã‚¤ãƒ›ãƒ¯ã‚¤ãƒˆ","jan":"4547410489149","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒ‘ã‚¹ãƒ†ãƒ«ãƒ–ãƒ«ãƒ¼","jan":"4547410489118","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒ©ã‚¤ãƒ©ãƒƒã‚¯ãƒ‘ãƒ¼ãƒ—ãƒ«","jan":"4547410489156","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒŸãƒ³ãƒˆã‚°ãƒªãƒ¼ãƒ³","jan":"4547410489132","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒ–ãƒ­ãƒƒã‚µãƒ ãƒ”ãƒ³ã‚¯","jan":"4547410489125","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒã‚§ã‚­ ãã¾ãƒ¢ãƒ³","jan":"4547410557954","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini 12 ãƒã‚§ã‚­ EXPO 2025","jan":"4547410534122","buyback":11200,"retail":16800,"rate":66.67,"category":"ãã®ä»–"},
  {"name":"instax mini Evo ãƒã‚§ã‚­ Limited Edition PINK","jan":"4547410555844","buyback":52000,"retail":41580,"rate":125.06,"category":"ãã®ä»–"},
  {"name":"instax mini Evo ãƒã‚§ã‚­ USB ãƒ–ãƒ©ãƒƒã‚¯","jan":"4547410520088","buyback":25500,"retail":34650,"rate":73.59,"category":"ãã®ä»–"}
];

// =============================================================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
// =============================================================================
let allProducts = [];
let activeFilter = 'ã™ã¹ã¦';
let activeSimFilter = 'ã™ã¹ã¦';
let customSelections = {};  // jan -> quantity
let lastResult = null;

// =============================================================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =============================================================================
async function loadData() {
  let products = EMBEDDED_DATA;
  
  try {
    const res = await fetch('data/prices.json?' + Date.now());
    if (res.ok) {
      const json = await res.json();
      // æ–°å½¢å¼: { updated, source, count, products: [...] }
      const fetched = json.products || json;
      if (Array.isArray(fetched) && fetched.length > 0) {
        // å¤–éƒ¨JSONã§è²·å–0å††ã®å ´åˆã€EMBEDDED_DATAã®å€¤ã‚’è£œå®Œ
        const embeddedMap = {};
        EMBEDDED_DATA.forEach(e => { if (e.jan) embeddedMap[e.jan] = e; });
        
        fetched.forEach(p => {
          if (p.buyback === 0 && p.jan && embeddedMap[p.jan]) {
            p.buyback = embeddedMap[p.jan].buyback;
            p.retail = embeddedMap[p.jan].retail || p.retail;
            p.rate = embeddedMap[p.jan].rate || p.rate;
          }
        });
        products = fetched;
        
        // æ›´æ–°æ—¥æ™‚
        if (json.updated) {
          const d = new Date(json.updated);
          if (!isNaN(d.getTime())) {
            document.getElementById('lastUpdate').textContent = 
              `æœ€çµ‚æ›´æ–°: ${d.toLocaleDateString('ja-JP')} ${d.toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'})}`;
          }
        }
      }
    }
  } catch(e) {
    console.log('Using EMBEDDED_DATA:', e);
  }
  
  // retail/rateãŒç„¡ã„å ´åˆã¯EMBEDDED_DATAã‹ã‚‰è£œå®Œ
  const embMap = {};
  EMBEDDED_DATA.forEach(e => { if (e.jan) embMap[e.jan] = e; });
  products.forEach(p => {
    if ((!p.retail || p.retail === 0) && p.jan && embMap[p.jan]) {
      p.retail = embMap[p.jan].retail;
    }
    if (p.retail > 0 && (!p.rate || p.rate === 0)) {
      p.rate = Math.round(p.buyback / p.retail * 10000) / 100;
    }
    if (!p.category) p.category = 'ãã®ä»–';
  });
  
  // buyback > 0 ã®ã¿
  allProducts = products.filter(p => p.buyback > 0);
  allProducts.sort((a, b) => (b.rate || 0) - (a.rate || 0));
  
  if (!document.getElementById('lastUpdate').textContent.includes('æœ€çµ‚æ›´æ–°')) {
    const now = new Date();
    document.getElementById('lastUpdate').textContent = 
      `æœ€çµ‚æ›´æ–°: ${now.toLocaleDateString('ja-JP')} ${now.toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'})}`;
  }
  
  buildFilters();
  renderProducts();
  renderCustomList();
}

// =============================================================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
// =============================================================================
function buildFilters() {
  const cats = ['ã™ã¹ã¦', ...new Set(allProducts.map(p => p.category))];
  
  const buildBtns = (containerId, setter) => {
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    cats.forEach(c => {
      const btn = document.createElement('button');
      btn.className = 'filter-btn' + (c === 'ã™ã¹ã¦' ? ' active' : '');
      btn.textContent = c;
      btn.onclick = () => {
        el.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        setter(c);
      };
      el.appendChild(btn);
    });
  };
  
  buildBtns('productFilters', c => { activeFilter = c; renderProducts(); });
  buildBtns('simFilters', c => { activeSimFilter = c; });
}

// =============================================================================
// å…¨å•†å“ä¸€è¦§
// =============================================================================
function renderProducts() {
  const list = document.getElementById('productList');
  const filtered = activeFilter === 'ã™ã¹ã¦' ? allProducts : allProducts.filter(p => p.category === activeFilter);
  
  if (filtered.length === 0) {
    list.innerHTML = '<div class="loading">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  list.innerHTML = filtered.map(p => {
    const rateClass = p.rate >= 100 ? 'rate-high' : p.rate >= 85 ? 'rate-mid' : 'rate-low';
    const profit = p.buyback - (p.retail || 0);
    return `
      <div class="product-item">
        <div class="product-info">
          <div class="product-name">${p.name}</div>
          <div class="product-prices">
            <span>å®šä¾¡ Â¥${(p.retail||0).toLocaleString()}</span>
            <span class="arrow">â†’</span>
            <span class="buyback">è²·å– Â¥${p.buyback.toLocaleString()}</span>
            ${profit > 0 ? `<span style="color:var(--success);font-weight:600">+Â¥${profit.toLocaleString()}</span>` : ''}
          </div>
        </div>
        <div class="product-rate ${rateClass}">${p.rate}%</div>
      </div>`;
  }).join('');
}

// =============================================================================
// æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
// =============================================================================
function renderCustomList() {
  const list = document.getElementById('customList');
  list.innerHTML = allProducts.map(p => {
    const qty = customSelections[p.jan] || 0;
    return `
      <div class="custom-product">
        <input type="checkbox" ${qty > 0 ? 'checked' : ''} onchange="toggleCustom('${p.jan}', this.checked)">
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.name}</div>
          <div style="font-size:0.75rem;color:var(--text-secondary)">Â¥${(p.retail||0).toLocaleString()} â†’ Â¥${p.buyback.toLocaleString()} (${p.rate}%)</div>
        </div>
        <div class="qty-controls" style="display:flex;align-items:center;gap:6px">
          <button class="qty-btn" onclick="changeCustomQty('${p.jan}',-1)">âˆ’</button>
          <span style="font-family:var(--font-en);font-weight:600;min-width:20px;text-align:center">${qty}</span>
          <button class="qty-btn" onclick="changeCustomQty('${p.jan}',1)">ï¼‹</button>
        </div>
      </div>`;
  }).join('');
  updateCustomSummary();
}

function toggleCustom(jan, checked) {
  if (checked && !customSelections[jan]) customSelections[jan] = 1;
  if (!checked) delete customSelections[jan];
  renderCustomList();
}

function changeCustomQty(jan, delta) {
  const current = customSelections[jan] || 0;
  const newQty = Math.max(0, current + delta);
  if (newQty === 0) delete customSelections[jan];
  else customSelections[jan] = newQty;
  renderCustomList();
}

function updateCustomSummary() {
  let totalRetail = 0, totalBuyback = 0;
  for (const [jan, qty] of Object.entries(customSelections)) {
    const p = allProducts.find(x => x.jan === jan);
    if (p) {
      totalRetail += (p.retail || 0) * qty;
      totalBuyback += p.buyback * qty;
    }
  }
  const profit = totalBuyback - totalRetail;
  const avgRate = totalRetail > 0 ? Math.round(totalBuyback / totalRetail * 10000) / 100 : 0;
  document.getElementById('customTotal').textContent = `Â¥${totalRetail.toLocaleString()}`;
  document.getElementById('customBuyback').textContent = `Â¥${totalBuyback.toLocaleString()}`;
  document.getElementById('customProfit').textContent = `${profit >= 0 ? '+' : ''}Â¥${profit.toLocaleString()}`;
  document.getElementById('customProfit').style.color = profit >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('customRate').textContent = `${avgRate}%`;
}

// =============================================================================
// ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼ˆãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰: Greedy + æ¢ç´¢ï¼‰
// =============================================================================
function executeSearch() {
  const points = parseInt(document.getElementById('pointsInput').value) || 0;
  const maxItems = parseInt(document.getElementById('maxItemsSelect').value) || 8;
  
  if (points < 1000) {
    document.getElementById('searchResult').innerHTML = '<div class="card" style="color:var(--danger)">1,000å††ä»¥ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
    return;
  }
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
  let candidates = allProducts.filter(p => p.buyback > 0 && p.retail > 0);
  if (activeSimFilter !== 'ã™ã¹ã¦') {
    candidates = candidates.filter(p => p.category === activeSimFilter);
  }
  
  // å€‹æ•°åˆ¶é™: é«˜é¡(Â¥30,000ä»¥ä¸Š)ã¯1å€‹ã€ãã‚Œä»¥å¤–ã¯æœ€å¤§3å€‹
  const getMaxQty = (p) => p.retail >= 30000 ? 1 : 3;
  
  // --- Greedyæ³•ï¼ˆ7æˆ¦ç•¥ï¼‰ ---
  const strategies = [
    // åˆ©ç›Šå„ªå…ˆ
    (a, b) => (b.buyback - b.retail) - (a.buyback - a.retail),
    // è²·å–ç‡å„ªå…ˆ
    (a, b) => b.rate - a.rate,
    // é«˜é¡å„ªå…ˆ
    (a, b) => b.retail - a.retail,
    // å®‰ã„é †ï¼ˆæ®‹é¡åŸ‹ã‚ï¼‰
    (a, b) => a.retail - b.retail,
    // åˆ©ç›Šç‡Ã—ä¾¡æ ¼
    (a, b) => (b.rate * b.retail) - (a.rate * a.retail),
    // åˆ©ç›Šé¡å„ªå…ˆï¼ˆãƒ—ãƒ©ã‚¹ã®ã¿å…ˆï¼‰
    (a, b) => {
      const aProfit = a.buyback > a.retail ? 1 : 0;
      const bProfit = b.buyback > b.retail ? 1 : 0;
      if (aProfit !== bProfit) return bProfit - aProfit;
      return b.rate - a.rate;
    },
    // ãƒ©ãƒ³ãƒ€ãƒ å¯„ã‚Šã®æ··åˆ
    (a, b) => (b.buyback - b.retail) * 0.5 + (b.rate - a.rate) * 100,
  ];
  
  let allResults = [];
  
  for (const maxTotal of [points, points + 5000, points + 10000]) {
    for (const sortFn of strategies) {
      const sorted = [...candidates].sort(sortFn);
      const result = greedyFill(sorted, candidates, points, maxTotal, maxItems, getMaxQty);
      if (result && result.items.length > 0) {
        allResults.push(result);
      }
    }
  }
  
  // --- æ¢ç´¢æ³• ---
  const highRate = candidates.filter(p => p.rate >= 90).sort((a, b) => b.rate - a.rate).slice(0, 20);
  if (highRate.length > 0) {
    const explored = exploreSearch(highRate, candidates, points, maxItems, getMaxQty);
    allResults.push(...explored);
  }
  
  // --- æœ€é©è§£é¸æŠ ---
  // æ¶ˆåŒ–ç‡97%ä»¥ä¸Šã§æœ€é«˜åˆ©ç›Š
  let best = null;
  for (const r of allResults) {
    const usage = r.totalRetail / points;
    if (usage >= 0.97) {
      if (!best || r.profit > best.profit) best = r;
    }
  }
  // 97%ä»¥ä¸ŠãŒãªã‘ã‚Œã°æ¶ˆåŒ–ç‡é †
  if (!best) {
    allResults.sort((a, b) => {
      const aUsage = a.totalRetail / points;
      const bUsage = b.totalRetail / points;
      if (Math.abs(aUsage - bUsage) > 0.02) return bUsage - aUsage;
      return b.profit - a.profit;
    });
    best = allResults[0];
  }
  
  if (!best || best.items.length === 0) {
    document.getElementById('searchResult').innerHTML = '<div class="card">æ¡ä»¶ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ãƒ³ãƒˆé¡ã‚„ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</div>';
    return;
  }
  
  lastResult = best;
  renderResult(best, points);
}

function greedyFill(sortedCandidates, allProducts, points, maxTotal, maxItems, getMaxQty) {
  const items = [];  // {product, qty}
  let totalRetail = 0;
  let totalBuyback = 0;
  let count = 0;
  const used = {};  // jan -> qty
  
  // ãƒ‘ã‚¹1: ã‚½ãƒ¼ãƒˆé †ã«è©°ã‚ã‚‹
  for (const p of sortedCandidates) {
    if (count >= maxItems) break;
    if (totalRetail >= maxTotal) break;
    
    const maxQ = Math.min(getMaxQty(p), maxItems - count);
    for (let q = 0; q < maxQ; q++) {
      if (totalRetail + p.retail > maxTotal) break;
      if (count >= maxItems) break;
      
      const curQty = used[p.jan] || 0;
      if (curQty >= getMaxQty(p)) break;
      
      totalRetail += p.retail;
      totalBuyback += p.buyback;
      used[p.jan] = curQty + 1;
      count++;
      
      const existing = items.find(i => i.product.jan === p.jan);
      if (existing) existing.qty++;
      else items.push({ product: p, qty: 1 });
    }
  }
  
  // ãƒ‘ã‚¹2: æ®‹é¡ã‚’allProductså…¨ä½“ã‹ã‚‰åŸ‹ã‚ã‚‹ï¼ˆbuyback>0 & rate>=50ï¼‰
  const fillers = allProducts
    .filter(p => p.buyback > 0 && p.rate >= 50)
    .sort((a, b) => a.retail - b.retail);  // å®‰ã„é †
  
  for (const p of fillers) {
    if (count >= maxItems) break;
    
    const maxQ = Math.min(getMaxQty(p), maxItems - count);
    for (let q = 0; q < maxQ; q++) {
      if (totalRetail + p.retail > maxTotal) break;
      if (count >= maxItems) break;
      
      const curQty = used[p.jan] || 0;
      if (curQty >= getMaxQty(p)) break;
      
      totalRetail += p.retail;
      totalBuyback += p.buyback;
      used[p.jan] = curQty + 1;
      count++;
      
      const existing = items.find(i => i.product.jan === p.jan);
      if (existing) existing.qty++;
      else items.push({ product: p, qty: 1 });
    }
  }
  
  const profit = totalBuyback - totalRetail;
  const avgRate = totalRetail > 0 ? Math.round(totalBuyback / totalRetail * 10000) / 100 : 0;
  
  return { items, totalRetail, totalBuyback, profit, avgRate, count };
}

function exploreSearch(highRate, allProducts, points, maxItems, getMaxQty) {
  const results = [];
  const SEARCH_LIMIT = 500;
  let searched = 0;
  
  const minPrice = points * 0.97;
  
  function dfs(idx, items, totalRetail, totalBuyback, count, used) {
    if (searched >= SEARCH_LIMIT) return;
    if (totalRetail > points) return;
    if (count > maxItems) return;
    
    if (totalRetail >= minPrice && count <= maxItems) {
      searched++;
      const profit = totalBuyback - totalRetail;
      const avgRate = totalRetail > 0 ? Math.round(totalBuyback / totalRetail * 10000) / 100 : 0;
      if (avgRate >= 90) {
        results.push({
          items: items.map(i => ({...i})),
          totalRetail, totalBuyback, profit, avgRate, count
        });
      }
    }
    
    for (let i = idx; i < highRate.length && searched < SEARCH_LIMIT; i++) {
      const p = highRate[i];
      const curQty = used[p.jan] || 0;
      if (curQty >= getMaxQty(p)) continue;
      if (totalRetail + p.retail > points) continue;
      
      const existing = items.find(x => x.product.jan === p.jan);
      if (existing) existing.qty++;
      else items.push({ product: p, qty: 1 });
      
      used[p.jan] = curQty + 1;
      
      dfs(i, items, totalRetail + p.retail, totalBuyback + p.buyback, count + 1, used);
      
      if (existing) existing.qty--;
      else items.pop();
      used[p.jan] = curQty;
      if (existing && existing.qty === 0) {
        items.splice(items.indexOf(existing), 1);
      }
    }
  }
  
  dfs(0, [], 0, 0, 0, {});
  return results;
}

// =============================================================================
// çµæœè¡¨ç¤º
// =============================================================================
function renderResult(result, points) {
  const usage = Math.round(result.totalRetail / points * 10000) / 100;
  const remaining = points - result.totalRetail;
  
  const el = document.getElementById('searchResult');
  el.innerHTML = `
    <div class="result-card">
      <div class="result-header">
        <span class="result-badge">ğŸ† æœ€é«˜åˆ©ç›Š</span>
        <span style="font-size:0.85rem;color:var(--text-secondary)">${result.count}ç‚¹ã®çµ„ã¿åˆã‚ã›</span>
      </div>
      <div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px">
        ãƒã‚¤ãƒ³ãƒˆ ${result.totalRetail.toLocaleString()}å††ä½¿ç”¨ï¼ˆæ¶ˆåŒ–ç‡ ${usage}%ï¼‰â†’ æ®‹ã‚Š ${remaining.toLocaleString()}å††
      </div>
      <div class="result-stats">
        <div class="result-stat">
          <div class="value profit">${result.profit >= 0 ? '+' : ''}Â¥${result.profit.toLocaleString()}</div>
          <div class="label">åˆ©ç›Š</div>
        </div>
        <div class="result-stat">
          <div class="value">${result.count}å€‹</div>
          <div class="label">å€‹æ•°</div>
        </div>
        <div class="result-stat">
          <div class="value">Â¥${result.totalBuyback.toLocaleString()}</div>
          <div class="label">åˆè¨ˆè²·å–</div>
        </div>
        <div class="result-stat">
          <div class="value">${result.avgRate}%</div>
          <div class="label">å¹³å‡è²·å–ç‡</div>
        </div>
        <div class="result-stat">
          <div class="value">${usage}%</div>
          <div class="label">æ¶ˆåŒ–ç‡</div>
        </div>
      </div>
      ${result.items.map(i => {
        const p = i.product;
        const rateClass = p.rate >= 100 ? 'rate-high' : p.rate >= 85 ? 'rate-mid' : 'rate-low';
        return `
          <div class="result-item ${p.rate >= 100 ? 'result-item-highlight' : ''}">
            <div style="flex:1;min-width:0">
              <div style="font-weight:600;font-size:0.85rem">${p.name}</div>
              <div style="font-size:0.75rem;color:var(--text-secondary)">
                å®šä¾¡ Â¥${(p.retail||0).toLocaleString()} â†’ <span style="color:var(--success);font-weight:600">è²·å– Â¥${p.buyback.toLocaleString()}</span>
              </div>
            </div>
            <div class="product-rate ${rateClass}">${p.rate}%</div>
            <div class="qty-controls">
              <button class="qty-btn" onclick="adjustResult('${p.jan}',-1)">âˆ’</button>
              <span style="font-family:var(--font-en);font-weight:600">${i.qty}</span>
              <button class="qty-btn" onclick="adjustResult('${p.jan}',1)">ï¼‹</button>
            </div>
          </div>`;
      }).join('')}
      ${remaining > 0 ? `<div class="result-remaining">æ®‹ã‚Š Â¥${remaining.toLocaleString()} ã§è¿½åŠ ã§ãã‚‹å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</div>` : ''}
    </div>`;
}

function adjustResult(jan, delta) {
  if (!lastResult) return;
  const item = lastResult.items.find(i => i.product.jan === jan);
  if (!item) return;
  
  const newQty = item.qty + delta;
  if (newQty <= 0) {
    lastResult.items = lastResult.items.filter(i => i.product.jan !== jan);
  } else {
    item.qty = newQty;
  }
  
  // å†è¨ˆç®—
  let tr = 0, tb = 0, cnt = 0;
  lastResult.items.forEach(i => {
    tr += (i.product.retail || 0) * i.qty;
    tb += i.product.buyback * i.qty;
    cnt += i.qty;
  });
  lastResult.totalRetail = tr;
  lastResult.totalBuyback = tb;
  lastResult.profit = tb - tr;
  lastResult.avgRate = tr > 0 ? Math.round(tb / tr * 10000) / 100 : 0;
  lastResult.count = cnt;
  
  const points = parseInt(document.getElementById('pointsInput').value) || 0;
  renderResult(lastResult, points);
}

// =============================================================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================================================
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// èµ·å‹•
loadData();
</script>
</body>
</html>
