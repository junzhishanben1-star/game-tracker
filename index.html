<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ® ã‚²ãƒ¼ãƒ æ©Ÿ è²·å–ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Zen+Kaku+Gothic+New:wght@400;500;700;900&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #f5f5f7;
  --card: #ffffff;
  --header-bg: #1a1a2e;
  --header-text: #ffffff;
  --primary: #4361ee;
  --primary-light: #eef0ff;
  --success: #10b981;
  --success-light: #ecfdf5;
  --warning: #f59e0b;
  --warning-light: #fffbeb;
  --danger: #ef4444;
  --text: #1a1a2e;
  --text-secondary: #6b7280;
  --border: #e5e7eb;
  --radius: 12px;
  --font-ja: 'Zen Kaku Gothic New', sans-serif;
  --font-en: 'DM Sans', sans-serif;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: var(--font-ja); background: var(--bg); color: var(--text); min-height: 100vh; -webkit-text-size-adjust: 100%; }

/* Header */
.header { background: var(--header-bg); color: var(--header-text); padding: 24px 20px; }
.header h1 { font-size: 1.5rem; font-weight: 900; margin-bottom: 4px; }
.header .meta { font-size: 0.8rem; color: rgba(255,255,255,0.6); display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.header .meta .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; flex-shrink: 0; }

/* Tabs */
.tabs { display: flex; background: var(--card); border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 100; }
.tab { flex: 1; padding: 14px 8px; text-align: center; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; transition: all 0.2s; user-select: none; -webkit-tap-highlight-color: transparent; }
.tab:hover { color: var(--text); background: #f9f9fb; }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }

/* Container */
.container { max-width: 900px; margin: 0 auto; padding: 16px; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Cards */
.card { background: var(--card); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
.card h2 { font-size: 1.1rem; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }

/* Simulator input row â€“ CSS Grid ã§ç¢ºå®Ÿã«æ¨ªä¸¦ã³ï¼‹é«˜ã•æƒãˆ */
.sim-row {
  display: grid;
  grid-template-columns: 1fr 180px;
  gap: 12px;
  align-items: start;
  margin-bottom: 16px;
}
.sim-row .field label {
  display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; line-height: 1.4;
}
.sim-row .field .hint {
  font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;
}
input[type="number"], select {
  display: block; width: 100%; padding: 10px 14px; border: 2px solid var(--border); border-radius: 8px;
  font-size: 1rem; font-family: var(--font-en); transition: border-color 0.2s;
  height: 44px; background: #fff;
  -webkit-appearance: none; appearance: none;
}
select { cursor: pointer; background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' stroke-width='2' fill='none'/%3E%3C/svg%3E") no-repeat right 12px center; padding-right: 36px; }
input:focus, select:focus { outline: none; border-color: var(--primary); }

/* Filter buttons */
.filter-section { margin-bottom: 16px; }
.filter-section > label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
.filters {
  display: flex; flex-wrap: wrap; gap: 8px;
  position: relative; z-index: 1;
}
.filter-btn {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 7px 16px; border: 2px solid var(--border); border-radius: 20px;
  background: white; cursor: pointer; font-size: 0.85rem; font-weight: 500;
  font-family: var(--font-ja); color: var(--text); transition: all 0.15s;
  white-space: nowrap; user-select: none;
  -webkit-tap-highlight-color: transparent; line-height: 1.2;
}
.filter-btn:hover { border-color: var(--primary); color: var(--primary); }
.filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

/* Primary button */
.btn-primary {
  display: block; width: 100%; padding: 14px; background: var(--primary); color: white; border: none;
  border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s;
  -webkit-tap-highlight-color: transparent; font-family: var(--font-ja);
}
.btn-primary:hover { opacity: 0.9; }

/* Product list */
.product-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px; border-bottom: 1px solid var(--border); transition: background 0.15s;
}
.product-item:last-child { border-bottom: none; }
.product-item:hover { background: #f9f9fb; }
.product-info { flex: 1; min-width: 0; }
.product-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.product-prices { display: flex; gap: 8px; align-items: center; font-size: 0.8rem; color: var(--text-secondary); flex-wrap: wrap; }
.product-prices .arrow { color: #ccc; }
.product-prices .buyback { color: var(--success); font-weight: 700; font-family: var(--font-en); }
.product-rate { font-family: var(--font-en); font-weight: 700; font-size: 0.95rem; min-width: 70px; text-align: right; flex-shrink: 0; }
.rate-high { color: var(--success); }
.rate-mid { color: var(--warning); }
.rate-low { color: var(--danger); }

/* Result card */
.result-card {
  background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  border: 2px solid #f59e0b; border-radius: var(--radius); padding: 20px; margin-top: 16px;
}
.result-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.result-badge { background: var(--success); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 700; white-space: nowrap; }
.result-stats {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 8px; margin-bottom: 16px;
  font-family: var(--font-en); text-align: center;
}
.result-stat .value { font-size: 1.2rem; font-weight: 700; }
.result-stat .value.profit { color: var(--success); }
.result-stat .label { font-size: 0.7rem; color: var(--text-secondary); font-family: var(--font-ja); margin-top: 2px; }
.result-item {
  background: white; border-radius: 8px; padding: 12px 16px; margin-bottom: 8px;
  display: flex; align-items: center; gap: 8px;
}
.result-item .ri-info { flex: 1; min-width: 0; }
.result-item .ri-rate { font-family: var(--font-en); font-weight: 700; font-size: 0.95rem; min-width: 60px; text-align: right; flex-shrink: 0; }
.result-item .qty-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.qty-btn {
  width: 28px; height: 28px; border-radius: 50%; border: 2px solid var(--border);
  background: white; cursor: pointer; font-size: 1rem;
  display: inline-flex; align-items: center; justify-content: center;
  -webkit-tap-highlight-color: transparent; padding: 0; line-height: 1;
}
.qty-btn:hover { border-color: var(--primary); color: var(--primary); }
.result-item-highlight { background: #fffde7; }
.result-remaining { text-align: center; color: var(--text-secondary); font-size: 0.85rem; margin-top: 12px; }

/* Custom tab */
.custom-summary {
  background: var(--primary-light); border-radius: 8px; padding: 16px; margin-bottom: 16px;
  display: grid; grid-template-columns: repeat(4, 1fr);
  gap: 8px; font-family: var(--font-en); text-align: center;
}
.custom-stat .value { font-size: 1.1rem; font-weight: 700; }
.custom-stat .label { font-size: 0.7rem; color: var(--text-secondary); font-family: var(--font-ja); margin-top: 2px; }
.custom-product {
  display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);
}
.custom-product:last-child { border-bottom: none; }
.custom-product input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary); flex-shrink: 0; }

/* Footer */
.footer { text-align: center; padding: 24px; color: var(--text-secondary); font-size: 0.75rem; }
.footer a { color: var(--primary); }
.loading { text-align: center; padding: 40px; color: var(--text-secondary); }

/* Responsive */
@media (max-width: 600px) {
  .sim-row { grid-template-columns: 1fr; }
  .result-stats { grid-template-columns: repeat(3, 1fr); }
  .result-stat .value { font-size: 1rem; }
  .custom-summary { grid-template-columns: repeat(2, 1fr); }
  .product-item { flex-direction: column; align-items: flex-start; gap: 6px; }
  .product-rate { text-align: left; }
  .result-item { flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ® ã‚²ãƒ¼ãƒ æ©Ÿ è²·å–ç‡ãƒˆãƒ©ãƒƒã‚«ãƒ¼</h1>
  <div class="meta">
    <span class="dot"></span>
    <span id="lastUpdate">èª­ã¿è¾¼ã¿ä¸­...</span>
    <span>ãƒ‡ãƒ¼ã‚¿å…ƒ: ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="simulator">ğŸ” ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
  <div class="tab" data-tab="custom">ğŸ›  æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</div>
  <div class="tab" data-tab="products">ğŸ“¦ å…¨å•†å“ä¸€è¦§</div>
</div>

<div class="container">

  <!-- Simulator -->
  <div id="tab-simulator" class="tab-content active">
    <div class="card">
      <h2>ğŸ¯ ãƒã‚¤ãƒ³ãƒˆæ¶ˆåŒ–ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</h2>
      <div class="sim-row">
        <div class="field">
          <label>æŒã£ã¦ã„ã‚‹ãƒã‚¤ãƒ³ãƒˆï¼ˆå††ç›¸å½“ï¼‰</label>
          <input type="number" id="pointsInput" value="145000" min="1000" step="1000">
          <div class="hint" style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©ãƒ»ãƒ¤ãƒãƒ€é›»æ©Ÿç­‰ã®ãƒã‚¤ãƒ³ãƒˆ</div>
        </div>
        <div class="field">
          <label>å€‹æ•°ä¸Šé™</label>
          <select id="maxItemsSelect">
            <option value="5">5å€‹</option>
            <option value="8">8å€‹</option>
            <option value="12">12å€‹</option>
            <option value="20">20å€‹</option>
            <option value="999">åˆ¶é™ãªã—</option>
          </select>
          <div class="hint" style="font-size:0.75rem;color:var(--text-secondary);margin-top:4px">ãƒã‚¤ãƒ³ãƒˆé¡ã«å¿œã˜ã¦è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™</div>
        </div>
      </div>
      <div class="filter-section">
        <label>ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</label>
        <div class="filters" id="simFilters"></div>
      </div>
      <button type="button" class="btn-primary" onclick="executeSearch()">ğŸ” æœ€é©ãªçµ„ã¿åˆã‚ã›ã‚’æ¤œç´¢</button>
    </div>
    <div id="searchResult"></div>
  </div>

  <!-- Custom -->
  <div id="tab-custom" class="tab-content">
    <div class="card">
      <h2>ğŸ›  æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º</h2>
      <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:16px">å•†å“ã‚’è‡ªåˆ†ã§é¸ã‚“ã§çµ„ã¿åˆã‚ã›ã‚’ç¢ºèªã§ãã¾ã™</p>
      <div class="custom-summary" id="customSummary">
        <div class="custom-stat"><div class="value" id="customTotal">Â¥0</div><div class="label">åˆè¨ˆå®šä¾¡</div></div>
        <div class="custom-stat"><div class="value" id="customBuyback">Â¥0</div><div class="label">åˆè¨ˆè²·å–</div></div>
        <div class="custom-stat"><div class="value" id="customProfit">Â¥0</div><div class="label">åˆ©ç›Š</div></div>
        <div class="custom-stat"><div class="value" id="customRate">0%</div><div class="label">å¹³å‡è²·å–ç‡</div></div>
      </div>
      <div id="customList"></div>
    </div>
  </div>

  <!-- Products -->
  <div id="tab-products" class="tab-content">
    <div class="card">
      <h2>ğŸ“Š å…¨å•†å“ä¸€è¦§</h2>
      <div class="filters" id="productFilters"></div>
      <div id="productList"><div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div></div>
    </div>
  </div>

</div>

<div class="footer">
  ãƒ‡ãƒ¼ã‚¿å…ƒ: <a href="https://www.mobile-ichiban.com/Prod/2/01" target="_blank">ãƒ¢ãƒã‚¤ãƒ«ä¸€ç•ª</a> | 3æ™‚é–“ã”ã¨è‡ªå‹•æ›´æ–°<br>
  Â© 2026 C-Creation
</div>

<script>
// =============================================================================
// EMBEDDED_DATA
// =============================================================================
var EMBEDDED_DATA = [
  {"name":"Nintendo Switch (æœ‰æ©ŸELãƒ¢ãƒ‡ãƒ«) ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼ãƒ»ãƒã‚ªãƒ³ãƒ¬ãƒƒãƒ‰","jan":"4902370548501","buyback":40700,"retail":37980,"rate":107.16,"category":"Switch"},
  {"name":"Nintendo Switch (æœ‰æ©ŸELãƒ¢ãƒ‡ãƒ«) ãƒ›ãƒ¯ã‚¤ãƒˆ","jan":"4902370548495","buyback":40700,"retail":37980,"rate":107.16,"category":"Switch"},
  {"name":"PlayStation 5 Pro CFI-7000B01 2TB","jan":"4948872416320","buyback":107300,"retail":119980,"rate":89.43,"category":"PS5"},
  {"name":"PlayStation 5 slim CFI-2000A01","jan":"4948872415934","buyback":74700,"retail":79980,"rate":93.4,"category":"PS5"},
  {"name":"Meta Quest 3S 128GB","jan":"0815820025238","buyback":38600,"retail":48400,"rate":79.75,"category":"Meta Quest"},
  {"name":"Nintendo Switch 2 Pokemon LEGENDS Z-A ã‚»ãƒƒãƒˆ å›½å†…ç‰ˆ","jan":"4902370553505","buyback":51000,"retail":49980,"rate":102.04,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 å¤šè¨€èªå¯¾å¿œç‰ˆ","jan":"4902370552683","buyback":85000,"retail":69980,"rate":121.46,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 å›½å†…ç‰ˆ","jan":"4902370553024","buyback":46300,"retail":49980,"rate":92.64,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 ãƒãƒªã‚ªã‚«ãƒ¼ãƒˆ ãƒ¯ãƒ¼ãƒ«ãƒ‰ ã‚»ãƒƒãƒˆ å›½å†…ç‰ˆ","jan":"4902370553031","buyback":51500,"retail":55980,"rate":92.0,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 Proã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼","jan":"4902370552843","buyback":8300,"retail":9878,"rate":84.03,"category":"Switch 2"},
  {"name":"Joy-Con 2 (L)/(R) ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼/ãƒ©ã‚¤ãƒˆãƒ¬ãƒƒãƒ‰","jan":"4902370552744","buyback":8600,"retail":9878,"rate":87.06,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con 2 (L) ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼","jan":"4902370552706","buyback":3500,"retail":5478,"rate":63.89,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con 2 (R) ãƒ©ã‚¤ãƒˆãƒ¬ãƒƒãƒ‰","jan":"4902370552720","buyback":3500,"retail":5478,"rate":63.89,"category":"Switch 2"},
  {"name":"Nintendo Switch 2 ãƒ‰ãƒƒã‚¯ã‚»ãƒƒãƒˆ","jan":"4902370552911","buyback":11200,"retail":12980,"rate":86.29,"category":"Switch 2"},
  {"name":"SanDisk microSD Express Card 256GB for Nintendo Switch 2","jan":"4523052030185","buyback":5800,"retail":6578,"rate":88.17,"category":"Switch 2"},
  {"name":"Samsung microSD Express Card 256GB for Nintendo Switch 2","jan":"8806095700670","buyback":5800,"retail":6578,"rate":88.17,"category":"Switch 2"},
  {"name":"Nintendo Switch Joy-Con(L) ãƒã‚ªãƒ³ãƒ–ãƒ«ãƒ¼/(R) ãƒã‚ªãƒ³ãƒ¬ãƒƒãƒ‰ æ–°å‹","jan":"4902370550733","buyback":32500,"retail":32978,"rate":98.55,"category":"Switch"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ç”¨ãƒ•ã‚£ãƒ«ãƒ  20æšå…¥ INSTAX MINI JP 2","jan":"4547410377231","buyback":2680,"retail":2100,"rate":127.62,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ç”¨ãƒ•ã‚£ãƒ«ãƒ  10æšå…¥ INSTAX MINI JP 1","jan":"4547410377224","buyback":1300,"retail":1100,"rate":118.18,"category":"ãã®ä»–"},
  {"name":"FUJIFILM å†™ãƒ«ãƒ³ã§ã™ ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ¼ã‚¹ 27æšæ’®ã‚Š","jan":"4547410369137","buyback":2600,"retail":2178,"rate":119.38,"category":"ãã®ä»–"},
  {"name":"FUJIFILM å†™ãƒ«ãƒ³ã§ã™ ã‚·ãƒ³ãƒ—ãƒ«ã‚¨ãƒ¼ã‚¹ 27æšæ’®ã‚Š 2025ç‰ˆ","jan":"4547410550955","buyback":2500,"retail":2178,"rate":114.78,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ã‚¹ã‚¯ã‚¨ã‚¢ç”¨ ãƒ•ã‚£ãƒ«ãƒ  20æš WW2","jan":"4547410370003","buyback":2400,"retail":2100,"rate":114.29,"category":"ãã®ä»–"},
  {"name":"FUJIFILM ãƒã‚§ã‚­ã‚¹ã‚¯ã‚¨ã‚¢ç”¨ ãƒ•ã‚£ãƒ«ãƒ  10æš WW1","jan":"4547410348613","buyback":1200,"retail":1100,"rate":109.09,"category":"ãã®ä»–"}
];

var allProducts = [];
var activeFilter = 'ã™ã¹ã¦';
var activeSimFilter = 'ã™ã¹ã¦';
var customSelections = {};
var lastResult = null;

// =============================================================================
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
// =============================================================================
async function loadData() {
  var products = EMBEDDED_DATA;
  try {
    var res = await fetch('data/prices.json?' + Date.now());
    if (res.ok) {
      var json = await res.json();
      var fetched = json.products || json;
      if (Array.isArray(fetched) && fetched.length > 0) {
        var embeddedMap = {};
        EMBEDDED_DATA.forEach(function(e) { if (e.jan) embeddedMap[e.jan] = e; });
        fetched.forEach(function(p) {
          if (p.buyback === 0 && p.jan && embeddedMap[p.jan]) {
            p.buyback = embeddedMap[p.jan].buyback;
            p.retail = embeddedMap[p.jan].retail || p.retail;
            p.rate = embeddedMap[p.jan].rate || p.rate;
          }
        });
        products = fetched;
        if (json.updated) {
          var d = new Date(json.updated);
          if (!isNaN(d.getTime())) {
            document.getElementById('lastUpdate').textContent =
              'æœ€çµ‚æ›´æ–°: ' + d.toLocaleDateString('ja-JP') + ' ' + d.toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'});
          }
        }
      }
    }
  } catch(e) { console.log('Using EMBEDDED_DATA:', e); }

  var embMap = {};
  EMBEDDED_DATA.forEach(function(e) { if (e.jan) embMap[e.jan] = e; });
  products.forEach(function(p) {
    if ((!p.retail || p.retail === 0) && p.jan && embMap[p.jan]) p.retail = embMap[p.jan].retail;
    if (p.retail > 0 && (!p.rate || p.rate === 0)) p.rate = Math.round(p.buyback / p.retail * 10000) / 100;
    if (!p.category) p.category = 'ãã®ä»–';
  });

  allProducts = products.filter(function(p) { return p.buyback > 0; });
  allProducts.sort(function(a, b) { return (b.rate || 0) - (a.rate || 0); });

  if (!document.getElementById('lastUpdate').textContent.includes('æœ€çµ‚æ›´æ–°')) {
    var now = new Date();
    document.getElementById('lastUpdate').textContent =
      'æœ€çµ‚æ›´æ–°: ' + now.toLocaleDateString('ja-JP') + ' ' + now.toLocaleTimeString('ja-JP', {hour:'2-digit',minute:'2-digit'});
  }

  buildFilters();
  renderProducts();
  renderCustomList();
}

// =============================================================================
// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ§‹ç¯‰
// =============================================================================
function buildFilters() {
  var cats = ['ã™ã¹ã¦'];
  var seen = {};
  allProducts.forEach(function(p) { if (!seen[p.category]) { seen[p.category] = true; cats.push(p.category); } });

  function build(containerId, currentVal, setter) {
    var el = document.getElementById(containerId);
    if (!el) return;
    el.innerHTML = '';
    cats.forEach(function(c) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'filter-btn' + (c === currentVal ? ' active' : '');
      btn.textContent = c;
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var all = el.querySelectorAll('.filter-btn');
        for (var i = 0; i < all.length; i++) all[i].classList.remove('active');
        btn.classList.add('active');
        setter(c);
      });
      el.appendChild(btn);
    });
  }

  build('productFilters', activeFilter, function(c) { activeFilter = c; renderProducts(); });
  build('simFilters', activeSimFilter, function(c) { activeSimFilter = c; });
}

// =============================================================================
// å…¨å•†å“ä¸€è¦§
// =============================================================================
function renderProducts() {
  var list = document.getElementById('productList');
  var filtered = activeFilter === 'ã™ã¹ã¦' ? allProducts : allProducts.filter(function(p) { return p.category === activeFilter; });
  if (filtered.length === 0) { list.innerHTML = '<div class="loading">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var h = '';
  for (var i = 0; i < filtered.length; i++) {
    var p = filtered[i];
    var rc = p.rate >= 100 ? 'rate-high' : p.rate >= 85 ? 'rate-mid' : 'rate-low';
    var pr = p.buyback - (p.retail || 0);
    h += '<div class="product-item"><div class="product-info">';
    h += '<div class="product-name">' + p.name + '</div>';
    h += '<div class="product-prices"><span>å®šä¾¡ Â¥' + (p.retail||0).toLocaleString() + '</span>';
    h += '<span class="arrow">â†’</span><span class="buyback">è²·å– Â¥' + p.buyback.toLocaleString() + '</span>';
    if (pr > 0) h += '<span style="color:var(--success);font-weight:600">+Â¥' + pr.toLocaleString() + '</span>';
    h += '</div></div><div class="product-rate ' + rc + '">' + p.rate + '%</div></div>';
  }
  list.innerHTML = h;
}

// =============================================================================
// æ‰‹å‹•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
// =============================================================================
function renderCustomList() {
  var list = document.getElementById('customList');
  var h = '';
  for (var i = 0; i < allProducts.length; i++) {
    var p = allProducts[i];
    var qty = customSelections[p.jan] || 0;
    h += '<div class="custom-product">';
    h += '<input type="checkbox" ' + (qty > 0 ? 'checked' : '') + ' onchange="toggleCustom(\'' + p.jan + '\',this.checked)">';
    h += '<div style="flex:1;min-width:0"><div style="font-weight:600;font-size:0.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + p.name + '</div>';
    h += '<div style="font-size:0.75rem;color:var(--text-secondary)">Â¥' + (p.retail||0).toLocaleString() + ' â†’ Â¥' + p.buyback.toLocaleString() + ' (' + p.rate + '%)</div></div>';
    h += '<div style="display:flex;align-items:center;gap:6px;flex-shrink:0">';
    h += '<button type="button" class="qty-btn" onclick="changeCustomQty(\'' + p.jan + '\',-1)">âˆ’</button>';
    h += '<span style="font-family:var(--font-en);font-weight:600;min-width:20px;text-align:center">' + qty + '</span>';
    h += '<button type="button" class="qty-btn" onclick="changeCustomQty(\'' + p.jan + '\',1)">ï¼‹</button>';
    h += '</div></div>';
  }
  list.innerHTML = h;
  updateCustomSummary();
}
function toggleCustom(jan, checked) {
  if (checked && !customSelections[jan]) customSelections[jan] = 1;
  if (!checked) delete customSelections[jan];
  renderCustomList();
}
function changeCustomQty(jan, delta) {
  var cur = customSelections[jan] || 0;
  var nq = Math.max(0, cur + delta);
  if (nq === 0) delete customSelections[jan]; else customSelections[jan] = nq;
  renderCustomList();
}
function updateCustomSummary() {
  var tR = 0, tB = 0;
  for (var jan in customSelections) {
    var qty = customSelections[jan];
    var p = allProducts.find(function(x) { return x.jan === jan; });
    if (p) { tR += (p.retail || 0) * qty; tB += p.buyback * qty; }
  }
  var pr = tB - tR;
  var ar = tR > 0 ? Math.round(tB / tR * 10000) / 100 : 0;
  document.getElementById('customTotal').textContent = 'Â¥' + tR.toLocaleString();
  document.getElementById('customBuyback').textContent = 'Â¥' + tB.toLocaleString();
  document.getElementById('customProfit').textContent = (pr >= 0 ? '+' : '') + 'Â¥' + pr.toLocaleString();
  document.getElementById('customProfit').style.color = pr >= 0 ? 'var(--success)' : 'var(--danger)';
  document.getElementById('customRate').textContent = ar + '%';
}

// =============================================================================
// ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
// =============================================================================
// =============================================================================
// è³¼å…¥åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯
// =============================================================================
// Switchç³»æœ¬ä½“ã®JANã‚³ãƒ¼ãƒ‰ï¼ˆ1äºº1å°åˆ¶é™ã‚°ãƒ«ãƒ¼ãƒ—ï¼‰
var SWITCH1_CONSOLES = ['4902370548501','4902370548495']; // æœ‰æ©ŸEL ãƒã‚ªãƒ³/ãƒ›ãƒ¯ã‚¤ãƒˆ
var SWITCH2_CONSOLES = ['4902370553505','4902370552683','4902370553024','4902370553031']; // Switch 2æœ¬ä½“4ç¨®

function getMaxQty(p) { return p.retail >= 25000 ? 1 : 3; }

// ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§æ—¢ã«è³¼å…¥æ¸ˆã¿ã®å°æ•°ã‚’ãƒã‚§ãƒƒã‚¯
function getGroupRemaining(p, used) {
  var jan = p.jan;
  // Switch 1æœ¬ä½“ã‚°ãƒ«ãƒ¼ãƒ—: åˆè¨ˆ1å°ã¾ã§
  if (SWITCH1_CONSOLES.indexOf(jan) !== -1) {
    var total = 0;
    for (var i = 0; i < SWITCH1_CONSOLES.length; i++) total += (used[SWITCH1_CONSOLES[i]] || 0);
    return Math.max(0, 1 - total);
  }
  // Switch 2æœ¬ä½“ã‚°ãƒ«ãƒ¼ãƒ—: åˆè¨ˆ1å°ã¾ã§
  if (SWITCH2_CONSOLES.indexOf(jan) !== -1) {
    var total = 0;
    for (var i = 0; i < SWITCH2_CONSOLES.length; i++) total += (used[SWITCH2_CONSOLES[i]] || 0);
    return Math.max(0, 1 - total);
  }
  // ãã‚Œä»¥å¤–ã¯é€šå¸¸åˆ¶é™
  var cq = used[jan] || 0;
  return Math.max(0, getMaxQty(p) - cq);
}

function executeSearch() {
  var points = parseInt(document.getElementById('pointsInput').value) || 0;
  var maxItems = parseInt(document.getElementById('maxItemsSelect').value) || 8;
  if (points < 1000) { document.getElementById('searchResult').innerHTML = '<div class="card" style="color:var(--danger)">1,000å††ä»¥ä¸Šã®ãƒã‚¤ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>'; return; }

  var candidates = allProducts.filter(function(p) { return p.buyback > 0 && p.retail > 0; });
  if (activeSimFilter !== 'ã™ã¹ã¦') candidates = candidates.filter(function(p) { return p.category === activeSimFilter; });

  var strategies = [
    function(a,b){return(b.buyback-b.retail)-(a.buyback-a.retail)},
    function(a,b){return b.rate-a.rate},
    function(a,b){return b.retail-a.retail},
    function(a,b){return a.retail-b.retail},
    function(a,b){return(b.rate*b.retail)-(a.rate*a.retail)},
    function(a,b){var aP=a.buyback>a.retail?1:0,bP=b.buyback>b.retail?1:0;if(aP!==bP)return bP-aP;return b.rate-a.rate},
    function(a,b){return(b.buyback-b.retail)*0.5+(b.rate-a.rate)*100}
  ];

  var allResults = [];
  for (var s = 0; s < strategies.length; s++) {
    var sorted = candidates.slice().sort(strategies[s]);
    var r = greedyFill(sorted, candidates, points, maxItems);
    if (r && r.items.length > 0) allResults.push(r);
  }

  var highRate = candidates.filter(function(p){return p.rate>=90}).sort(function(a,b){return b.rate-a.rate}).slice(0,20);
  if (highRate.length > 0) {
    var explored = exploreSearch(highRate, candidates, points, maxItems);
    for (var i = 0; i < explored.length; i++) allResults.push(explored[i]);
  }

  allResults = allResults.filter(function(r){return r.totalRetail<=points});

  var best = null;
  var ths = [0.98, 0.97, 0.95, 0.90, 0];
  for (var t = 0; t < ths.length; t++) {
    var valid = allResults.filter(function(r){return r.totalRetail/points>=ths[t]});
    if (valid.length > 0) { valid.sort(function(a,b){return b.profit-a.profit}); best = valid[0]; break; }
  }

  if (!best || best.items.length === 0) { document.getElementById('searchResult').innerHTML = '<div class="card">æ¡ä»¶ã«åˆã†çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>'; return; }
  lastResult = best;
  renderResult(best, points);
}

function greedyFill(sorted, allCand, points, maxItems) {
  var items=[],tR=0,tB=0,cnt=0,used={};
  for(var i=0;i<sorted.length;i++){
    var p=sorted[i]; if(cnt>=maxItems||tR>=points)break;
    var avail=getGroupRemaining(p,used);
    if(avail<=0)continue;
    var mq=Math.min(avail,maxItems-cnt);
    for(var q=0;q<mq;q++){
      if(tR+p.retail>points||cnt>=maxItems)break;
      if(getGroupRemaining(p,used)<=0)break;
      tR+=p.retail;tB+=p.buyback;used[p.jan]=(used[p.jan]||0)+1;cnt++;
      var ex=items.find(function(x){return x.product.jan===p.jan});
      if(ex)ex.qty++;else items.push({product:p,qty:1});
    }
  }
  // Pass 2
  var rem=points-tR;
  if(rem>0&&cnt<maxItems){
    var fill=allCand.slice().filter(function(p){return p.buyback>0&&p.retail<=rem}).sort(function(a,b){return b.rate-a.rate});
    for(var i=0;i<fill.length;i++){
      var p=fill[i]; if(cnt>=maxItems)break;
      var avail=getGroupRemaining(p,used);
      if(avail<=0)continue;
      var mq=Math.min(avail,maxItems-cnt);
      for(var q=0;q<mq;q++){
        if(tR+p.retail>points||cnt>=maxItems)break;
        if(getGroupRemaining(p,used)<=0)break;
        tR+=p.retail;tB+=p.buyback;used[p.jan]=(used[p.jan]||0)+1;cnt++;
        var ex=items.find(function(x){return x.product.jan===p.jan});
        if(ex)ex.qty++;else items.push({product:p,qty:1});
      }
    }
  }
  return{items:items,totalRetail:tR,totalBuyback:tB,profit:tB-tR,avgRate:tR>0?Math.round(tB/tR*10000)/100:0,count:cnt};
}

function exploreSearch(highRate, allCand, points, maxItems) {
  var results=[],LIMIT=500,searched=0,minP=points*0.90;
  function dfs(idx,items,tR,tB,cnt,used){
    if(searched>=LIMIT||tR>points||cnt>maxItems)return;
    if(tR>=minP&&cnt<=maxItems){
      searched++;
      var rem=points-tR,rc=maxItems-cnt;
      if(rem>0&&rc>0){
        var fill=allCand.filter(function(p){return p.buyback>0&&p.retail<=rem}).sort(function(a,b){return b.rate-a.rate});
        var eR=0,eB=0,eC=0,eU={};for(var k in used)eU[k]=used[k];
        var eI=items.map(function(x){return{product:x.product,qty:x.qty}});
        for(var fi=0;fi<fill.length;fi++){
          var fp=fill[fi]; if(eC>=rc)break;
          var avail=getGroupRemaining(fp,eU);
          if(avail<=0)continue;
          var mq=Math.min(avail,rc-eC);
          for(var fq=0;fq<mq;fq++){
            if(tR+eR+fp.retail>points)break;
            if(getGroupRemaining(fp,eU)<=0)break;
            eR+=fp.retail;eB+=fp.buyback;eU[fp.jan]=(eU[fp.jan]||0)+1;eC++;
            var ex=eI.find(function(x){return x.product.jan===fp.jan});
            if(ex)ex.qty++;else eI.push({product:fp,qty:1});
          }
        }
        var ttR=tR+eR,ttB=tB+eB;
        results.push({items:eI,totalRetail:ttR,totalBuyback:ttB,profit:ttB-ttR,avgRate:ttR>0?Math.round(ttB/ttR*10000)/100:0,count:cnt+eC});
      }
      var ar=tR>0?Math.round(tB/tR*10000)/100:0;
      if(ar>=90) results.push({items:items.map(function(x){return{product:x.product,qty:x.qty}}),totalRetail:tR,totalBuyback:tB,profit:tB-tR,avgRate:ar,count:cnt});
    }
    for(var i=idx;i<highRate.length&&searched<LIMIT;i++){
      var p=highRate[i];
      if(getGroupRemaining(p,used)<=0||tR+p.retail>points)continue;
      var ex=items.find(function(x){return x.product.jan===p.jan});
      if(ex)ex.qty++;else items.push({product:p,qty:1});
      used[p.jan]=(used[p.jan]||0)+1;
      dfs(i,items,tR+p.retail,tB+p.buyback,cnt+1,used);
      if(ex){ex.qty--;if(ex.qty===0)items.splice(items.indexOf(ex),1);}else items.pop();
      used[p.jan]=used[p.jan]-1;
    }
  }
  dfs(0,[],0,0,0,{});
  return results;
}

// =============================================================================
// çµæœè¡¨ç¤º
// =============================================================================
function renderResult(result, points) {
  var usage = Math.round(result.totalRetail / points * 10000) / 100;
  var rem = points - result.totalRetail;
  var maxI = parseInt(document.getElementById('maxItemsSelect').value) || 8;
  var canAdd = allProducts.some(function(p){return p.buyback>0&&p.retail>0&&p.retail<=rem}) && result.count < maxI;

  var h = '<div class="result-card">';
  h += '<div class="result-header"><span class="result-badge">ğŸ† æœ€é«˜åˆ©ç›Š</span><span style="font-size:0.85rem;color:var(--text-secondary)">' + result.count + 'ç‚¹ã®çµ„ã¿åˆã‚ã›</span></div>';
  h += '<div style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px">ãƒã‚¤ãƒ³ãƒˆ ' + result.totalRetail.toLocaleString() + 'å††ä½¿ç”¨ï¼ˆæ¶ˆåŒ–ç‡ ' + usage + '%ï¼‰â†’ æ®‹ã‚Š ' + rem.toLocaleString() + 'å††</div>';
  h += '<div class="result-stats">';
  h += '<div class="result-stat"><div class="value profit">' + (result.profit>=0?'+':'') + 'Â¥' + result.profit.toLocaleString() + '</div><div class="label">åˆ©ç›Š</div></div>';
  h += '<div class="result-stat"><div class="value">' + result.count + 'å€‹</div><div class="label">å€‹æ•°</div></div>';
  h += '<div class="result-stat"><div class="value">Â¥' + result.totalBuyback.toLocaleString() + '</div><div class="label">åˆè¨ˆè²·å–</div></div>';
  h += '<div class="result-stat"><div class="value">' + result.avgRate + '%</div><div class="label">å¹³å‡è²·å–ç‡</div></div>';
  h += '<div class="result-stat"><div class="value">' + usage + '%</div><div class="label">æ¶ˆåŒ–ç‡</div></div>';
  h += '</div>';

  for (var i = 0; i < result.items.length; i++) {
    var it = result.items[i], p = it.product;
    var rc = p.rate>=100?'rate-high':p.rate>=85?'rate-mid':'rate-low';
    h += '<div class="result-item ' + (p.rate>=100?'result-item-highlight':'') + '">';
    h += '<div class="ri-info"><div style="font-weight:600;font-size:0.85rem">' + p.name + '</div>';
    h += '<div style="font-size:0.75rem;color:var(--text-secondary)">å®šä¾¡ Â¥' + (p.retail||0).toLocaleString() + ' â†’ <span style="color:var(--success);font-weight:600">è²·å– Â¥' + p.buyback.toLocaleString() + '</span></div></div>';
    h += '<div class="ri-rate ' + rc + '">' + p.rate + '%</div>';
    h += '<div class="qty-controls"><button type="button" class="qty-btn" onclick="adjustResult(\'' + p.jan + '\',-1)">âˆ’</button>';
    h += '<span style="font-family:var(--font-en);font-weight:600">' + it.qty + '</span>';
    h += '<button type="button" class="qty-btn" onclick="adjustResult(\'' + p.jan + '\',1)">ï¼‹</button></div></div>';
  }
  if (rem > 0 && !canAdd) h += '<div class="result-remaining">æ®‹ã‚Š Â¥' + rem.toLocaleString() + ' ã§è¿½åŠ ã§ãã‚‹å•†å“ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  h += '</div>';
  document.getElementById('searchResult').innerHTML = h;
}

function adjustResult(jan, delta) {
  if (!lastResult) return;
  var item = lastResult.items.find(function(i){return i.product.jan===jan});
  if (!item) return;
  if (item.qty + delta <= 0) lastResult.items = lastResult.items.filter(function(i){return i.product.jan!==jan});
  else item.qty += delta;
  var tR=0,tB=0,cnt=0;
  lastResult.items.forEach(function(i){tR+=(i.product.retail||0)*i.qty;tB+=i.product.buyback*i.qty;cnt+=i.qty});
  lastResult.totalRetail=tR;lastResult.totalBuyback=tB;lastResult.profit=tB-tR;
  lastResult.avgRate=tR>0?Math.round(tB/tR*10000)/100:0;lastResult.count=cnt;
  renderResult(lastResult, parseInt(document.getElementById('pointsInput').value)||0);
}

// =============================================================================
// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
// =============================================================================
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active')});
    document.querySelectorAll('.tab-content').forEach(function(c){c.classList.remove('active')});
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// =============================================================================
// ãƒã‚¤ãƒ³ãƒˆé¡ã«å¿œã˜ãŸå€‹æ•°ä¸Šé™ã®è‡ªå‹•èª¿æ•´
// =============================================================================
function autoAdjustMaxItems() {
  var pts = parseInt(document.getElementById('pointsInput').value) || 0;
  var sel = document.getElementById('maxItemsSelect');
  var best;
  if (pts <= 50000) best = '5';
  else if (pts <= 100000) best = '8';
  else if (pts <= 200000) best = '12';
  else best = '20';
  sel.value = best;
}
document.getElementById('pointsInput').addEventListener('change', autoAdjustMaxItems);
document.getElementById('pointsInput').addEventListener('input', autoAdjustMaxItems);

// åˆæœŸå®Ÿè¡Œ
autoAdjustMaxItems();
loadData();
</script>
</body>
</html>
